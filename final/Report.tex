\documentclass[a4paper, 12pt]{report}

\usepackage[style=numeric]{biblatex}
\usepackage[utf8]{inputenc}
\usepackage{amsmath}
\usepackage{etoolbox}
\usepackage{float}
\usepackage{geometry}
\usepackage{graphicx}
\usepackage{hyperref}

\addbibresource{References.bib}
\graphicspath{ {images/} }

\makeatletter

\patchcmd{\@makechapterhead}{50\p@}{\chapheadtopskip}{}{}
\patchcmd{\@makeschapterhead}{50\p@}{\chapheadtopskip}{}{}

\makeatother

\newlength{\chapheadtopskip}\setlength{\chapheadtopskip}{5mm}

\title{
	{Fail-Safe Cloud Tournament Engine with Error Detection and Error Recovery} \\
	{\includegraphics[scale=1.4]{logo.png}}
}
\author{
	{Kyle Chapman (20703236)} \\
	{\emph{Supervisor: Dr. Cornelia P. Inggs}} \\
	{\emph{Cosupervisor: Mr. Andrew J. Collett}}
}
\date{9 November 2020}

\begin{document}

\maketitle
\tableofcontents

\chapter{Introduction}

The Fail-Safe Cloud Tournament Engine (FSCTE) is an extension of the Cloud
Tournament Engine (CTE) developed by Reece Murray in 2018, which is an extension
of the Tournament Engine (TE) built on the Ingenious Framework\footnote{\url{https://bitbucket.org/skroon/ingenious-framework/src/master/}}
(IF). The goal for the CTE is to allow people to play a turn-based game, provided
it is supported in the IF, against each other in a match, where many matches
make up a tournament. Multiple tournaments can be run to determine how good
each player is. Tournaments can separated into two categories: private and public. \\

Private tournaments are tournaments that only the administrators can add players
to, and they are mainly used to test some players against other players. Public
tournaments are tournaments that any user can add their own players to and
administrators can also add players to. These tournaments are used to put players
against each other to rank each player based on how many wins they get against
other players. \\

It was found that there were some major limitations to the CTE, such as minimal
error reporting, lack of error recovery and an unmaintainable code base to name
a few. As a result, there were situations that arose in which a player failure
resulted in a failure of the entire tournament. This prompted the need for a
version that was fail-safe and included error reporting and error recovery, as
far as possible. The FSCTE aims to address these limitations and improve the
overall system stability by being fail-safe, which means that if any error were
to occur, the response to the error would cause as little harm to the overall
system stability as possible.

\section{Scope}

The system used to manage the FSCTE is made up of multiple Docker\footnote{\url{https://docs.docker.com/engine/docker-overview/}}
containers, which run each section of the FSCTE in their own separate environment.
If some error occurs in a section of the system, it will not affect the other
sections, since they are in separate environments. \\

The FSCTE uses the following three main sections that are run in their own
Docker containers:

\begin{itemize}
	\item \textbf{Web User Interface}: Allows a user to interact directly with
	the FSCTE.
	\item \textbf{Database}: Stores all the information relevant to the FSCTE.
	\item \textbf{Database Watcher (Golang)}: Watches the database for any changes,
	such as tournaments being started, and sends messages to the front-end
	accordingly.
	\item \textbf{REST API}: Facilitates file upload to, and download from, the
	web user interface, as well as CAS authentication for logging in with
	Stellenbosch University credentials.
\end{itemize}

The layout of the entire FSCTE system is further discussed in chapter
\ref{chap:design}, \emph{design and implementation}.

\section{Document Outline}

This report will discuss the overview of the system in chapter \ref{chap:overview},
the implementation and design of the system in chapter \ref{chap:design}, then
onto the testing in chapter \ref{chap:testing} and discussion of the future of
the project in chapter \ref{chap:future}. Finally, the conclusion will be
presented in chapter \ref{chap:conclusion}.

\chapter{Overview}
\label{chap:overview}

This chapter will give an overview of the requirements for the FSCTE system and
how the requirements have been met. \\

The CTE used in $3^{\text{rd}}$ year at Stellenbosch
University is designed to manage many Othello \cite{othello} tournaments,
involving many players, concurrently. A user is able to view public tournaments,
players, referees, schedulers, etc. and view relevant statistics for
ongoing and completed tournaments. The admin, usually the lecturer, is
able to add tournaments, schedulers and rankers and the students are only allowed
to upload their players and add them to public tournaments.

\section{Separate enviroments}

Each section of the FSCTE needs to be in their own separate environment, so that
if some error occurs, it impacts only that specific section and not the entire
FSCTE. Docker was chosen for this purpose, since it is relatively easy to spin
up a section in its own environment and redeploy that section if some error
occurs. \\

The docker container is created by writing a \texttt{Dockerfile} that
specifies which base environment you want to use (e.g. \texttt{ubuntu},
\texttt{node}, \texttt{neo4j} etc.) and the command you want to run in the
container. The container exits when the command finishes, so in order to keep
the container running forever, infinite loops are useful. This means that the
command will only finish when the user forcefully stops the container. \\

Docker-compose\footnote{\url{https://docs.docker.com/compose/}} is used to spin
up all of the docker containers used by the FSCTE,
using their respective \texttt{Dockerfile}s, and allows for more control of how
the container should be set up. Local directories can be mounted into the docker
containers so that any files that are generated inside the container can be
accessed outside of the container, on the host machine. This is useful for
accessing the log files after a match has completed, so that it can be seen if
the match was a success or not.

\section{Web User Interface}

The previous web user interface implemented in the CTE was not very user-friendly,
which resulted in a lot of confusion for the students who used the CTE. The entire
web user interface in the FSCTE was written from scratch using new technologies,
such as Vue\footnote{\url{https://vuejs.org/}} and
TypeScript\footnote{\url{https://www.typescriptlang.org/}}, so that it was more
visually appealing and easier for the lecturers and students to use. Students
and lecturers (or admins) can log into the web user interface using Stellenbosch
University Single-Sign On or by specifying their username and password if they
already exist in the database. \\

The students are able to upload their players to the web user interface and join
public tournaments with their players. The students can have as many players as
they would like, and each of the players are added to the tournament standings
once they join a tournament. This allows the students to see how their players
perform relative to other players in the same tournaments. \\

The lecturers, or admins, are able to upload their own rankers, schedulers,
referees and players to the web user interface. More will be explained about the
rankers, schedulers and referees in chapter \ref{sec:impl-web-interface}. The
admins can also add their own players to public or private tournaments, as well
as they can add a student's player to a public or private tournament. The admins
can start and stop tournaments, as well as create new tournaments. \\

After a match has completed, either ending in a failure or success, the log files
of that match can be accessed if the student or admin desires. This means that
either the student or admin can see what moves both the players made and the
final result of the match.

\section{Software Stack}

The FSCTE uses the following software stack:
\begin{itemize}
	\item \textbf{Vue} - Front-end framework that is used to interact with the
	FSCTE.
	\item \textbf{Typescript} - Superset of JavaScript that adds types, which
	is useful for catching bugs before they make it into production.
	\item \textbf{Python} - Used to create the REST API that facilitates
	file upload to, and download from, the web user interface, as well as providing
	authentication for logging in using Stellenbosch University Single-Sign On.
	\item \textbf{Neo4j} - Database that is used to store all the information
	necessary for the FSCTE to work. Highly relational database that uses the
	Cypher\footnote{\url{https://neo4j.com/docs/cypher-manual/current/}} query
	language to get or set attributes.
	\item \textbf{Golang} - Used to schedule matches in tournaments concurrently,
	with less overhead than using Java.
	\item \textbf{Docker} - Tool to allow different components of the FSCTE to
	operate in their own separate environments.
	\item \textbf{Bash} - Used for writing scripts that will setup the FSCTE and
	download any necessary programs.
\end{itemize}
The host system does not need to have docker pre-installed, since the FSCTE will
check if docker and docker-compose are available in the setup script. If one or
more programs are not installed, the script will download the necessary version
onto the host machine.

\chapter{Design and Implementation}
\label{chap:design}

This chapter will describe the design and implementation of all the components
present in the FSCTE. Figure \ref{fig:uml-structure} shows an overview of the
components present in the FSCTE and how they interact.
\begin{figure}[H]
	\centering
	\includegraphics[scale=0.25]{uml-structure.png}
	\caption{UML diagram representing the structure of the FSCTE}
	\label{fig:uml-structure}
\end{figure}

\section{Overview}
\label{sec:impl-overview}

This section serves as an explanation for what can be seen in the UML diagram in
Figure \ref{fig:uml-structure}. \\

The actor represents a user, who can be either an admin or student. This user
only interacts with the web user interface to add players, tournaments and anything
the user desires, provided they have the correct permissions. \\

The rectangles with a blue outline represent docker containers and the rectangles
with a dotted orange line represent entities inside the docker containers. The
dotted grey line represents the docker container in which an entity resides.

\section{Web User Interface}
\label{sec:impl-web-interface}

This section serves as an explanation for the purpose of the web user interface
docker container seen in Figure \ref{fig:uml-structure}. \\

The web user interface is designed to be a Single-Page Application (SPA) that
uses components to render specific ``pages'', instead of the traditional way of
rendering complete HTML pages when the user navigates to a different URL route.
This is accomplished by swapping out certain HTML elements with other elements
so that the content of the page changes without having to re-render the elements
that are present in both pages. As such, the performance of a SPA is significantly
better than a traditional web app because of the reduced rendering needed to
display different pages. Vue\footnote{\url{https://vuejs.org/}} was chosen as the
framework to use because it is extremely easy to use and provides support for
creating a SPA. An example of the login screen for the web user interface can be
seen in Figure \ref{fig:login} in the Appendix. \\

The web user interface makes use of cookies to store the session, so that the
user stays logged in even when closing the web user interface browser tab. The
cookies are saved for seven days, meaning that once the cookies expire, the
user has to log in again. Since Vue was chosen as the front-end framework, the
library \texttt{VueCookies}\footnote{\url{https://www.npmjs.com/package/vue-cookies}}
was chosen as the way to store cookies in the web user interface. This library
was easy to use and provided many customizable options, as well as it is
regularly updated. \\

The web user interface consists of different tabs that a user can click to navigate
to different views. The tabs that can be accessed vary depending on the level of
permission of the logged in user, i.e. admins will be able to access more tabs
than students will be able to. However, some tabs are accessible regardless of
if a user is logged in or not. These tabs are the `Tournaments' tab, `Matches'
tab, `Standings' tab and finally the `About' tab. If user logs in as a student,
the user is able to access the `Players' tab as well as all of the tabs
accessible when not logged in. If the user logs in as an admin, the user is able
to access the `Components' tab as well as all of the tabs accessible to a student.
The above tabs will be explained in further detail from section
\ref{sec:impl-tab-tournaments} to \ref{sec:impl-tab-about}.

\subsection{`Tournaments' tab}
\label{sec:impl-tab-tournaments}

The `Tournaments' tab is accessible by a user who is not logged in, a student
and an admin. A screenshot of the page after clicking the tab can be seen in
Figure \ref{fig:all-tourn-student} in the Appendix, when logged in as a student,
and Figure \ref{fig:all-tourn-admin} in the Appendix, when logged in as an
admin.

\subsubsection*{User Not Logged In}

The user is able to view all of the public and private tournaments that are
taking place. An overview of the tournaments is provided where the name of the
tournament, the current status of the tournament (either ``Not Started'',
``Running'' or ``Finished''), the maximum time limit for each move (in milliseconds)
and the number of players currently in the tournament are displayed in a table.
There is a difference between a user and a player, where the user is the person
who is currently logged in (student or admin) and the player is an executable
that the user uploads to take part in tournaments. A user can have many players.

\subsection{`Matches' tab}
\label{sec:impl-tab-matches}

\subsection{`Players' tab}
\label{sec:impl-tab-players}

\subsection{`Standings' tab}
\label{sec:impl-tab-standings}

\subsection{`Components' tab}
\label{sec:impl-tab-components}

\subsection{`About' tab}
\label{sec:impl-tab-about}

\section{REST API}

This section serves as an explanation for the purpose of the REST API docker
container seen in Figure \ref{fig:uml-structure}. \\

\section{Database}

This section serves as an explanation for the purpose of the database docker
container seen in Figure \ref{fig:uml-structure}. \\

\section{Database Watcher}

This section serves as an explanation for the purpose of the database watcher
docker container seen in Figure \ref{fig:uml-structure}. \\

\subsection{Match Server}

\subsection{Match Client}

A scheduler is used to schedule matches between two players in a round-robin
\mbox{fashion}, where every player plays against every other player. After every player
has played against every other player, the overall win-loss ratio can be calculated
that can be used to \mbox{distinguish} between good, average and bad players. The
win-loss ratio and the Elo rating \cite{elo} can be used in conjunction. \\

A ranker is used to distinguish between the good and bad players by comparing
the Elo of the two players, where every player starts on the same amount of Elo.
For every win that a player has, they gain a certain amount of Elo and for every
loss that a player has, they lost a certain amount of Elo. The amount gained or
lost decreases for every match that the player plays, meaning that eventually
the Elo rating will be a true reflection of the skill level of the player. \\

A referee is used to monitor the moves that the two players make in a match and
check if any player makes an invalid move or times out. One player sends a
move to the referee, which then checks if the move is valid and only sends
the move to the other player if the move made is valid. If the move made is
invalid, or the player times out, the match will be forfeit and the last player
to send a valid move becomes the winner.

\chapter{Testing}
\label{chap:testing}

\chapter{Future Work}
\label{chap:future}

This chapter covers the future work that could be implemented in the Fail-Safe
Cloud Tournament Engine (FSCTE) to extend the current functionality. The
conclusion will be provided in section \ref{chap:conclusion}.

\section{Kubernetes}

Kubernetes\footnote{\url{https://kubernetes.io/}} can be used to manage the docker
containers, so that if a container crashes, another instance of that container
can be redeployed without hesitation. Due to time constraints, it was not feasible
to add Kubernetes to the current FSCTE.

\section{Other Game Types}

In the current FSCTE implementation, only the \texttt{Othello} game is supported.
Supporting other game types will allow the FSCTE to be more abstract and versatile.
Due to time constraints, it was not feasible to attempt to support other types
of games.

\chapter{Conclusion}
\label{chap:conclusion}

The main requirements of the FSCTE that needed to be satisfied were:
\begin{itemize}
	\item have effective error handling
	\item have effective debugging facilities
	\item scale with tournaments and players
	\item have a logical, clean and maintainable code base
	\item have a more user-friendly web user interface
\end{itemize}
All of the above requirements were satisfied. The error handling requirement
was satisfied by making sure that at any point where an error could occur, it
was decided if the error was serious or not. If the error was serious, then an
error message would be displayed and the component that caused the error would
be stopped. If the error was not serious, then an error message would be displayed,
but nothing would happen to the component that caused the error. \\

The effective debugging facilities requirement was satisfied by logging all
information that happens inside each docker container, so that if some error
occurs, the user can look in the docker logs to see at which stage the error
occurred. This allows the user to know exactly what was going on before the
error occurred so that the user can pinpoint the issue and fix the problem. \\

The tournaments and player scaling requirement was satisfied by writing the
code base in such a way that it performs very well for any number of tournaments
and players. Golang was mainly used to allow scaling to be possible through the
use of concurrent threads running different tasks at the same time. \\

The maintainable code base requirement was satisfied by providing extensive
documentation throughout the code base, so that anyone who reads the code base
can understand what is going on without any issue. \\

The user-friendly web user interface requirement was satisfied by ensuring that
the user can navigate to any page or get any information they want in a maximum
of two mouse clicks. A lot of time was spent making sure that the web user
interface looked clean and visually appealing, as well as easy to use. \\

Working on the FSCTE for the past year has been a great challenge, but also a
great reward. Initially, it was tough to understand what was going on in the CTE
because of the lack of documentation and confusing way that some sections were
implemented. After understanding the previous work, the toughest challenge was
getting the players to play a match and communicate their results to the web
user interface. However, it was a fun and informative experience.

\chapter{Appendix}

\section{Web User Interface}

The images from Figure \ref{fig:login} to \ref{fig:about-admin} are screenshots
from the web user interface that the admins and students will interact with.
\vspace{0.4cm}

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.41]{login.png}
	\caption{Login page}
	\label{fig:login}
\end{figure}
\begin{figure}[H]
	\centering
	\includegraphics[scale=0.37]{dashboard-admin.png}
	\caption{Dashboard after logging in as admin}
	\label{fig:dashboard-admin}
\end{figure}
\begin{figure}[H]
	\centering
	\includegraphics[scale=0.33]{all-tournaments-student.png}
	\caption{`Tournaments' tab when logged in as a student}
	\label{fig:all-tourn-student}
\end{figure}
\begin{figure}[H]
	\centering
	\includegraphics[scale=0.33]{all-tournaments-admin.png}
	\caption{`Tournaments' tab when logged in as an admin}
	\label{fig:all-tourn-admin}
\end{figure}
\begin{figure}[H]
	\centering
	\includegraphics[scale=0.37]{tournaments-admin.png}
	\caption{Page describing the tournament `Placements'}
	\label{fig:tourn-placements}
\end{figure}
\begin{figure}[H]
	\centering
	\includegraphics[scale=0.33]{settings-admin.png}
	\caption{Settings popup for the tournament `Placements' when the logged in user is an admin}
	\label{fig:settings-admin}
\end{figure}
\begin{figure}[H]
	\centering
	\includegraphics[scale=0.37]{about-admin.png}
	\caption{About page}
	\label{fig:about-admin}
\end{figure}

\printbibliography

\end{document}
